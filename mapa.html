<!DOCTYPE html>
<html lang="pt-br">

<head>

    <meta charset="utf-8" />
    <title>Acidentes de trânsito, 2019, Janeiro-Março</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --base: #00bcd4;
            --escuro: #333;
            --claro: white;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, Helvetica, sans-serif;
            height: 100%;
            width: 100%;
            overflow-x: hidden;
            overflow-y: hidden;
        }

        .conteiner1 {
            display: flex;
            overflow-x: hidden;
            overflow-y: hidden;
            height: 100%;
            min-height: 100%;
            width: 100%;
        }

        #mapa {
            background: var(--claro);
            flex: 4;
        }

        #consultabela {
            background: var(--claro);
            /* flex: 2; */
            width: 300px;
        }

        .leaflet-tooltip.rotulos {
            background-color: transparent;
            border: transparent;
            box-shadow: none;
            font-weight: bold;
            font-weight: 900;
            color: #000066;
        }
    </style>

</head>

<body>
    <div class='conteiner1'>
        <div id="mapa"></div>
        <div id="consultabela">
            <div id="chart_div"></div>
            <div id="columnchart_values"></div>
            <div id="donutchart"></div>
        </div>
    </div>

    <script>
        // Mapa
        let mapa = new L.Map('mapa', {
            zoom: 14,
            minZoom: 12,
            maxZoom: 20,
            maxBounds: [
                //south west
                [-27.3000, -49.2300],
                //north east
                [-26.3285, -48.3200]
            ],
            center: new L.latLng([-26.9046, -48.6874]),
            zoomControl: false,
            preferCanvas: true
        });

        // Mapa base, OSM
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(mapa);

        // barra escala
        L.control.scale({
            position: "bottomleft",
            imperial: false
        }).addTo(mapa);

        // Botão zoom posicionado
        L.control.zoom({
            position: 'bottomleft'
        }).addTo(mapa);

        // Norte
        let nortemapa = L.control({
            position: 'bottomleft'
        });
        nortemapa.onAdd = (map) => {
            let div = L.DomUtil.create('div', 'info2 legend');
            div.innerHTML +=
                '<center><sub><font size="4">▲</font></sub><br/>' +
                '<sup><font size="2">N</font></sup></center>'
            return div;
        };
        nortemapa.addTo(mapa);

        // Pontos ocorrências
        let pontosOcorrencias = L.featureGroup().addTo(mapa);
        let pontosOcortolltips = L.featureGroup();
        let pontoSelecionado = L.featureGroup().addTo(mapa);

        interacaofeicao = (feature, layer) => {
            layer.on({
                click: (feature) => {
                    pontoSelecionado.clearLayers();
                    L.marker(feature.target._latlng).addTo(pontoSelecionado);
                    drawChart();
                }
            });
        };

        $.getJSON("dados/agregado_intersecao.geojson", (data) => {
            L.geoJson(data, {
                pointToLayer: (feature, latlng) => {
                    let raio;
                    let cor;
                    if (feature.properties.total > 3) {
                        raio = feature.properties.total * 2
                        cor = '#e62e00'
                    } else if (feature.properties.total > 1) {
                        raio = feature.properties.total * 1.5;
                        cor = '#ff3300'
                    } else { raio = 3, cor = '#ff704d' };

                    return L.circleMarker(latlng, {
                        radius: raio,
                        color: cor
                    });
                },
                onEachFeature: interacaofeicao
            }).addTo(pontosOcorrencias);
            L.geoJson(data, {
                pointToLayer: (feature, latlng) => {
                    let raio;
                    let cor;
                    let label;
                    if (feature.properties.total > 2) {
                        label = String(feature.properties.total)
                    } else { label = '' };
                    if (feature.properties.total > 3) {
                        raio = feature.properties.total * 3
                        cor = '#e62e00'
                    } else if (feature.properties.total > 1) {
                        raio = feature.properties.total * 2.5;
                        cor = '#ff3300'
                    } else { raio = 5, cor = '#ff704d' };

                    return L.circleMarker(latlng, {
                        radius: raio,
                        color: cor
                    }).bindTooltip(label, { permanent: true, direction: 'center', className: "rotulos" }).openTooltip();
                },
                onEachFeature: interacaofeicao
            }).addTo(pontosOcortolltips);
        });

        //visibilidade, bairros/pontos ocorrências
        mapa.on('zoomend', () => {
            if (mapa.getZoom() < 14) {
                mapa.removeLayer(pontosOcorrencias);
                mapa.removeLayer(pontosOcortolltips);
            } else if (mapa.getZoom() >= 14 && mapa.getZoom() < 16) {
                mapa.addLayer(pontosOcorrencias);
                mapa.removeLayer(pontosOcortolltips);
            } else if (mapa.getZoom() >= 16) {
                mapa.removeLayer(pontosOcorrencias);
                mapa.addLayer(pontosOcortolltips);
            };
        });

        //Google charts
        // Load the Visualization API and the corechart package.
        google.charts.load('current', { 'packages': ['corechart'] });

        // Set a callback to run when the Google Visualization API is loaded.
        google.charts.setOnLoadCallback(drawChartA);
        google.charts.setOnLoadCallback(drawChartB);
        google.charts.setOnLoadCallback(drawChartC);

        // Callback that creates and populates a data table,
        // instantiates the pie chart, passes in the data and
        // draws it.
        function drawChartA() {
            var data = google.visualization.arrayToDataTable([
                ['Dinosaur', 'Length'],
                ['Acrocanthosaurus (top-spined lizard)', 12.2],
                ['Albertosaurus (Alberta lizard)', 9.1],
                ['Allosaurus (other lizard)', 12.2],
                ['Apatosaurus (deceptive lizard)', 22.9],
                ['Archaeopteryx (ancient wing)', 0.9],
                ['Argentinosaurus (Argentina lizard)', 36.6],
                ['Baryonyx (heavy claws)', 9.1],
                ['Brachiosaurus (arm lizard)', 30.5],
                ['Ceratosaurus (horned lizard)', 6.1],
                ['Coelophysis (hollow form)', 2.7],
                ['Compsognathus (elegant jaw)', 0.9],
                ['Deinonychus (terrible claw)', 2.7],
                ['Diplodocus (double beam)', 27.1],
                ['Dromicelomimus (emu mimic)', 3.4],
                ['Gallimimus (fowl mimic)', 5.5],
                ['Mamenchisaurus (Mamenchi lizard)', 21.0],
                ['Megalosaurus (big lizard)', 7.9],
                ['Microvenator (small hunter)', 1.2],
                ['Ornithomimus (bird mimic)', 4.6],
                ['Oviraptor (egg robber)', 1.5],
                ['Plateosaurus (flat lizard)', 7.9],
                ['Sauronithoides (narrow-clawed lizard)', 2.0],
                ['Seismosaurus (tremor lizard)', 45.7],
                ['Spinosaurus (spiny lizard)', 12.2],
                ['Supersaurus (super lizard)', 30.5],
                ['Tyrannosaurus (tyrant lizard)', 15.2],
                ['Ultrasaurus (ultra lizard)', 30.5],
                ['Velociraptor (swift robber)', 1.8]]);
            let options = {
                title: 'Lengths of dinosaurs, in meters',
                width: 300,
                height: 300,
                legend: { position: 'none' },
            };
            // Instantiate and draw our chart, passing in some options.
            let chartA = new google.visualization.Histogram(document.getElementById('chart_div'));
            chartA.draw(data, options);
        };

        function drawChartB() {
            let data = google.visualization.arrayToDataTable([
                ["Element", "Density", { role: "style" }],
                ["Copper", 8.94, "#b87333"],
                ["Silver", 10.49, "silver"],
                ["Gold", 19.30, "gold"],
                ["Platinum", 21.45, "color: #e5e4e2"]
            ]);

            let view = new google.visualization.DataView(data);
            view.setColumns([0, 1,
                {
                    calc: "stringify",
                    sourceColumn: 1,
                    type: "string",
                    role: "annotation"
                },
                2]);

            let options = {
                title: "Density of Precious Metals, in g/cm^3",
                width: 300,
                height: 300,
                bar: { groupWidth: "95%" },
                legend: { position: "none" }
            };
            let chartB = new google.visualization.ColumnChart(document.getElementById("columnchart_values"));
            chartB.draw(view, options);
        };

        function drawChartC() {
            let data = google.visualization.arrayToDataTable([
                ['Task', 'Hours per Day'],
                ['Work', 11],
                ['Eat', 2],
                ['Commute', 2],
                ['Watch TV', 2],
                ['Sleep', 7]
            ]);

            let options = {
                title: 'My Daily Activities',
                pieHole: 0.4,
                width: 300,
                height: 300,
                legend: {
                    position: "top",
                    maxLines: 5
                },
            };

            let chartC = new google.visualization.PieChart(document.getElementById('donutchart'));
            chartC.draw(data, options);
        };

    </script>

</body>

</html>